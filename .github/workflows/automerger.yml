name: 'Automerge'

on: pull_request_target

permissions:
  pull-requests: write
  contents: write

jobs:
  lockfile:
    name: 'Update bun lockfile'
    if: ${{ github.actor == 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository ğŸ‰ (dependabot)
        if: ${{ github.actor == 'dependabot[bot]' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup bun env ğŸ°
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies ğŸš€
        run: bun install

      - name: Setup GitHub Actor ğŸ¤–
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: Commit lockfile changes ğŸ“
        run: |
          git add .
          git commit -m "chore: update lockfile"
          git push
  dependabot:
    runs-on: ubuntu-latest
    name: 'Automerge Dependabot PRs'
    if: ${{ github.actor == 'dependabot[bot]' }}
    needs:
      - lockfile
    steps:
      - name: Dependabot metadata ğŸ¤–
        id: metadata
        uses: dependabot/fetch-metadata@v2.2.0
        with:
          alert-lookup: true
          compat-lookup: true
          github-token: ${{ secrets.DEPENDABOT_TOKEN }}

      - name: Authenticate CLI with PAT ğŸ”
        run: echo "${{ secrets.DEPENDABOT_TOKEN }}" | gh auth login --with-token

      - name: Approve Dependabot PRs ğŸ‘
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.DEPENDABOT_TOKEN }}

      - name: Auto-merge Dependabot PRs ğŸ•º
        if: steps.metadata.outputs.update-type == 'version-update:semver-minor' || steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.DEPENDABOT_TOKEN }}
